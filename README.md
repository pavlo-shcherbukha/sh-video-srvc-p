# video streaming через підключення IP камери по протоколу  rtsp

Тут описана інтеграція бібліотеик  opencv з IP камерою за протоколом RPSP.


Також описано, як запустити python-додаток, що інтегрується з камерою.  При цьому, додаток не "падає", якщо підключення до камери не відбулося. Додаток повторить підключення через заданий інтервал часу.
Конфігурація python-додатку береться з env-змінних. 
Додаток можна запустити і в контейнері і локлаьно.

Додаток робить програмну детекцію руху за допомогою бібліотеки open-cv, і, якщо рух виявлено, контурами показує рухомі області кадра і робить запис відеко протягом заданого інтервалу часу (30 секунд).
Записаний відео-файл копіюється в спеціальний каталог.

Щоб працювати з ip камерою через протокол RTSP можна піти кількома шляхами:

- **Купити ip камеру з підтримкою RTSP і підключити її до роутера.**

За звичай, RTSP підтримують камери TP-LINK серії TAPO (такий собі мас-маркет).

- **Встановити на мобільний телефон додаток ip-камера і підключити телефон по WI-FI до того ж роутера, що і комп'ютер.**

Для тестування підійде мобільний телефон з встановленим додатком ip-camera [pic-01](#pic-01). Тільки треба мати на увазі, що телефони, особливо старі, **довго працювати** в режимі камери за rptsp протоколом мабуть не будуть: то перегріваються, то пам'яті не вистачає. З мого досвіду - ну хвилин на 5-6 безперервної роботи телефону. Але для тестування цього більш ніж достатньо.

<kbd><img src="doc/ipcam.jpg" /></kbd>
<p style="text-align: center;"><a name="pic-01">pic-01</a></p>

- **використати вбудовану камеру Laptop.**

Щоб використати вбудовану камеру Laptop потрібно встановити RTSP-сервер. Я пошукав сервери у вигляді python пакетів - кілька з них відмовилися ставитись (не те що запускатися). Тому пішов іншим шляхом, створив Flask Web App, що емулює RTSP трафік. Для дослідів мені цього вистачить. А розгортати повноцінний сервер RTSP та конфігурувати його - я не захотів, тому написав свій емулятор rtsp  сервера, який треба запустити на вашому Laptop локлаьно (не в контейнері):

[Flask додаток для емуляціі RTSP video потоку за камери Notebook](https://github.com/pavlo-shcherbukha/sh-usbcam-as-rtsp)


## Запуск додатку локально в режимі debug


Для запуску додатку перш за все треба налаштувати env - змінні в файлі **/.vscode/launch.json**:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Python Debugger: vcam_runner.py",
      "type": "debugpy",
      "request": "launch",
      "program": "${workspaceFolder}/vcam_runner.py",
      "env": {
        "RTSP_URL": "Налаштувати rtsp URL камери в структурі: rtsp://username:password@host:port/path (для емулятора http://ip-windows-laptop/video)",
        "VIDEO_DIR": "video"

      }
    }
  ]
}

```

 Ну а далі, запускаємо додаток в режимі DEBUG.  і можна дебажити окремі компоненти

## Запуск в Docker container


- побудувати образ контейнера
```bash
docker build -t shimg-videosrvc:latest -f Dockerfile .
```

- запуск контейнера
```bash
# якщо використовуєте мобільний додаток ip-camera або реальну ip-камеру 
docker run  -v ./video:/app/video   -e RTSP_URL="rtsp://user:pasword@host:prot/path" -e VIDEO_DIR="video" shimg-videosrvc

#якщо використовувати мій емулятор
docker run  -v ./video:/app/video   -e RTSP_URL="http://host:8080/video" -e VIDEO_DIR="video" shimg-videosrvc

```

При запуску використовуються envidonment змінні:

- **RTSP_URL** - URL  вашої камери

- **VIDEO_DIR** - каталог, в який складаються записані файли


## Запуск на лінкукс машині як "додаток" у вигляді сервісу.і

Хоча Linux дозволяє тримати файли де завгодно, існують загальноприйняті стандарти:
- /opt/назва_проєкту — найкраще місце для стороннього софту, який не є частиною самої ОС. Це ізольовано і чисто.
- /home/<username>/назва_проєкту — теж допустимо, якщо ви один-єдиний користувач, але для системних сервісів краще використовувати /opt.

В даному випадку  розглядаємо структуру, що розміщується в каталозі /opt

Кроки для створення проекту в /opt з такими  вхідними даними:

- Нехай у мене буде папка проекту **"camera_monitor"**. Тому папку створюємо командою.
- А запускатися Raspberry буде під користувачем **pi**

Виконуємо такі кроки:

- Створюємо папку проекту.

```bash
    sudo mkdir -p /opt/camera_monitor
```


- Змінюємоь власника катаога так, щоб ваш користувач **pi** міг там працювати: 

```bash
    sudo chown pi:pi /opt/camera_monitor
```



Копіюємо в каталог додатка /opt/camera_monitor файли проекта
Створюємо файл змінних оточяення .env в каталозі додатку
З цього файлу додатко буде брати всі налаштування. Тому створюємо файл за допомогою редактора nano,

```
sudo nano /opt/camera_monitor/.env
```

та записуємо в нього такі змінні оточекння. Звичайно, їх треба змінити під ваші параметри.

.env

RTSP_URL="rtsp://username:password@host:port/path"
"VIDEO_DIR"="video"


Традиційно для Python, створюємо віртуальне середовище, активуємо його та встановлюємо в нього необхідні залежності

```bash
cd /opt/camera_monitor
python3 -m venv /opt/camera_monitor/env
source ./env/bin/activate
pip install -r requrements.txt
```

Далі, якщо ми хочемо запустити  додатко "як сервіс", що стартує при старті нашої віртуальної машини чи просто Linux  комп'ютера, то треба вконати такі дії:


- Створюємо файл сервіса

Для опису сервісу знову використовуючи реадктор nano створюємо файл конфігурації сервісу,

```bash
sudo nano /etc/systemd/system/cameramonitor.service
```

та вписуємо конфігурацію

```text
[Unit]
Description=RTSP Camera Monitoring Service
After=network-online.target
Wants=network-online.target

[Service]
# Шлях до папки з проєктом
WorkingDirectory=/opt/camera_monitor
# Вказуємо шлях до нашого файлу зі змінними
EnvironmentFile=/opt/camera_monitor/config.env
# Шлях до Python всередині venv та шлях до самого скрипта
ExecStart=/opt/camera_monitor/env/bin/python /opt/camera_monitor/vcam_runner.py

# Запуск від імені стандартного користувача RPi
User=pi
Group=pi

Restart=always
RestartSec=5

# Дозволяє бачити принти в логах journalctl одразу
Environment=PYTHONUNBUFFERED=1

[Install]
WantedBy=multi-user.target

```

Тут слід звенути увагу на те, що тепер ми не викристовуємо віртуальне середовище, а просто запускаємо python з каталога віртуального середовища. Щоб бачити вивід Python-скрипта прямо в логах systemctl — заслуга параметра Environment=PYTHONUNBUFFERED=1, який додано в конфігурацію. Без нього Python міг би накопичувати текст у буфері й видавати його пачками, а не в реальному часі. І в цьому файлі змннних Environment= можна задати стільки, скільки потрібно. Але, як на мене, то краще задавати змінні в файлі .env EnvironmentFile=/opt/camera_monitor/.env


- Запуск сервіса

Для запуску сервіса послідовно виконуємо таку послідовність команд

```bash
sudo systemctl daemon-reload
sudo systemctl enable cameramonitor.service
sudo systemctl start cameramonitor.service
```


- Подивитися логи роботи сервіса

Тепер перевіримо, що сервіс дійсно працює, шляхом перегляду "живого" лога його роботи

```bash
journalctl -u cameramonitor.service -f
```

-f вказує на те, що показувати лог в режимі реального часу


- Зупинка сервісу

Зупинка сервісу виконується командою:

sudo systemctl stop cameramonitor.service

І знову треба перевірити логи, що сервіс зупинився:

```bash
journalctl -u cameramonitor.service -f
```

- Дії, коли файл конфігурації сервісу треба змінити

Якщо виникла необхідність внести зміни у файл конфігурації сервісу (той, що /etc/systemd/system/cameramonitor.service), потрібно виконати два кроки, щоб система їх побачила і застосувала:

- Оновити конфігурацію systemd

Система зчитує файли сервісів у пам'ять лише під час завантаження або за спеціальною командою. Щоб вона помітила правки у файлі .service, потрібно виконати:

```bash
sudo systemctl daemon-reload
```

- Перезапустити сервіс

Команда daemon-reload лише оновлює "план дій" в пам'яті системи, але не зупиняє поточний процес. Щоб скрипт почав працювати за новими правилами, його треба перезавантажити:


```bash
sudo systemctl restart cameramonitor.service
```

***Важливе уточнення:**

Якщо ви змінили тільки файл .service (наприклад, змінили шлях до файлу, додали змінну оточення Environment або змінили таймер RestartSec): потрібно робити і daemon-reload, і restart.

Якщо ви змінили тільки код самого Python-скрипта: daemon-reload робити не потрібно. Достатньо просто виконати sudo systemctl restart cameramonitor.service, щоб скрипт перечитався з диска.




